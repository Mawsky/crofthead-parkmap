<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Crofthead Map Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-soft: #eef4ea;
      --frame-bg: #dfead6;
      --stroke: #4a4a4a;
      --hover-outline: #222;
    }
    html, body { height:100%; margin:0; background:var(--bg-soft); }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #wrap { width:100%; margin:0 auto; }
    #panel { padding:8px 12px; }
    /* Responsive aspect-ratio box; JS sets aspect-ratio: W/H */
    #frame {
      width: 100%;
      margin: 0 auto;
      background: var(--frame-bg);
      position: relative;
      /* aspect-ratio set in JS after reading JSON */
    }
    #map {
      width: 100%;
      height: 100%;
      display: block;
    }
    .pitch { opacity: 0.95; }
    .pitch:hover { opacity: 1; outline: 2px solid var(--hover-outline); cursor: pointer; }
    .tip {
      position: fixed; pointer-events: none;
      background: #111; color: #fff;
      padding: 6px 8px; border-radius: 6px;
      font-size: 12px; opacity: 0; transition: opacity .12s;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="panel">Crofthead interactive demo. Hover a block.</div>
    <div id="frame">
      <svg id="map" preserveAspectRatio="xMidYMid meet"></svg>
    </div>
  </div>
  <div id="tip" class="tip"></div>

  <script>
    async function boot() {
      // Load geometry
      const data = await fetch('crofthead_map.json').then(r => r.json());
      const W = Math.round(data.slide.width_pt);
      const H = Math.round(data.slide.height_pt);

      const svg = document.getElementById('map');
      const frame = document.getElementById('frame');
      const tip = document.getElementById('tip');

      // Lock the visual to the slide's aspect ratio (prevents cropping on odd screens)
      frame.style.aspectRatio = `${W} / ${H}`;
      svg.setAttribute('viewBox', `0 0 ${W} ${H}`);

      // Background image (optional). If not present, we keep the soft green.
      const bg = document.createElementNS('http://www.w3.org/2000/svg', 'image');
      bg.setAttribute('href', 'parkmap_background.png');
      bg.setAttribute('x', '0'); bg.setAttribute('y', '0');
      bg.setAttribute('width', W); bg.setAttribute('height', H);
      bg.addEventListener('error', () => { /* no-op; frame already has a background */ }, { once:true });
      svg.appendChild(bg);

      // Draw shapes
      const NS = 'http://www.w3.org/2000/svg';
      data.shapes.sort((a,b)=> (a.z||0) - (b.z||0));
      for (const s of data.shapes) {
        if (s.type === 'Line') continue; // skip exported line artefacts
        const x = s.x_pct * W, y = s.y_pct * H, w = s.w_pct * W, h = s.h_pct * H;
        const el = document.createElementNS(NS, 'rect');
        el.setAttribute('x', x); el.setAttribute('y', y);
        el.setAttribute('width', w); el.setAttribute('height', h);
        if (s.rotation_deg) {
          const cx = x + w/2, cy = y + h/2;
          el.setAttribute('transform', `rotate(${s.rotation_deg} ${cx} ${cy})`);
        }
        el.setAttribute('fill', s.fill || '#b3b3b3');
        el.setAttribute('stroke', s.stroke || getComputedStyle(document.documentElement).getPropertyValue('--stroke').trim());
        el.setAttribute('stroke-width', ((s.stroke_w_pt || 0.75) * 1.333));
        el.setAttribute('class', 'pitch');
        // Useful data attributes for tooltips/clicks
        el.dataset.id = s.id;
        el.dataset.name = s.name || '';
        svg.appendChild(el);
      }

      // Tooltip behaviour
      svg.addEventListener('mousemove', ev => {
        const t = ev.target;
        if (t.classList && t.classList.contains('pitch')) {
          tip.textContent = (t.dataset.name || 'Pitch') + (t.dataset.id ? ` (id ${t.dataset.id})` : '');
          tip.style.opacity = 0.95;
          tip.style.left = (ev.clientX + 12) + 'px';
          tip.style.top  = (ev.clientY + 12) + 'px';
        } else {
          tip.style.opacity = 0;
        }
      });
    }
    boot();
  </script>
</body>
</html>